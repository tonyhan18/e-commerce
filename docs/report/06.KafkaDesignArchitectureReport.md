# Kafka ë””ìì¸ ì•„í‚¤í…ì²˜ ë³´ê³ ì„œ

## ğŸ–¼ï¸ ë°°ê²½

ê¸°ì¡´ ì¿ í° ë°œê¸‰ ì‹œìŠ¤í…œì€ Redisì˜ **ì›ìì„± ë³´ì¥**ê³¼ **ë¹ ë¥¸ ì²˜ë¦¬ ì†ë„**ë¥¼ í™œìš©í•´ êµ¬í˜„ë˜ì–´ ìˆì—ˆë‹¤.

ê·¸ëŸ¬ë‚˜, **ì¦‰ì‹œ ë°œê¸‰ì´ ì•„ë‹Œ ë°°ì¹˜ ê¸°ë°˜ì˜ ë°œê¸‰ í”„ë¡œì„¸ìŠ¤**ë¡œ ì¸í•´  
ì‚¬ìš©ì ê´€ì ì—ì„œëŠ” **ì¿ í° ë°œê¸‰ ì§€ì—°** ë¬¸ì œê°€ ë°œìƒí–ˆë‹¤.

í˜„ì—… ê´€ì ìœ¼ë¡œëŠ” ì‚¬ìš©ì ê²½í—˜(UX)ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•˜ê¸° ë•Œë¬¸ì— **ì¦‰ì‹œì„± ìˆëŠ” ë°œê¸‰ ì²˜ë¦¬**ê°€ í•„ìš”í–ˆë‹¤.

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **Kafka ê¸°ë°˜ ì•„í‚¤í…ì²˜**ë¥¼ ë„ì…í•˜ì—¬,  
ì¿ í° ë°œê¸‰ì„ **ìˆœì°¨ ì²˜ë¦¬ ë° ì¦‰ì‹œ ë°œê¸‰** ê°€ëŠ¥í•œ êµ¬ì¡°ë¡œ ê°œì„ í•˜ê³ ì í–ˆë‹¤.

## ğŸ› ï¸ Kafka ê¸°ë°˜ ì „ëµ

Kafkaë¥¼ í™œìš©í•´ ì¿ í° ë°œê¸‰ ì‹œìŠ¤í…œì„ ê°œì„ í•˜ê¸° ìœ„í•œ í•µì‹¬ ì„¤ê³„ ìš”ì†ŒëŠ” **Topic êµ¬ì¡°ì™€ Partition ì „ëµ**ì´ë©°,  
ë‹¤ìŒ ë‘ ê°€ì§€ ë°©ì‹ì„ ê³ ë ¤í•˜ì˜€ë‹¤.

---

### 1) íŒŒí‹°ì…˜ í‚¤ë¥¼ ì¿ í° IDë¡œ ì„¤ì •

- **Topic**: `outside.coupon.publish.requested.v1`
- **Key**: `ì¿ í° ID`
- **Partition ìˆ˜**: 1ê°œ (ì¿ í° ID ë³„ë¡œ 1ê°œ íŒŒí‹°ì…˜)

**ì¿ í° IDë¥¼ íŒŒí‹°ì…˜ í‚¤ë¡œ ì‚¬ìš©**í•˜ë©´, ë™ì¼ ì¿ í°ì— ëŒ€í•œ ìš”ì²­ì´ **í•­ìƒ ë™ì¼ íŒŒí‹°ì…˜ìœ¼ë¡œ ë¼ìš°íŒ…**ëœë‹¤.  
ì´ë¥¼ í†µí•´ **ìˆœì°¨ ì²˜ë¦¬**ê°€ ê°€ëŠ¥í•˜ë©° êµ¬í˜„ì´ ë‹¨ìˆœí•˜ë‹¤.

**ì¥ì **:

- ë™ì¼ ì¿ í°ì— ëŒ€í•œ ìš”ì²­ ìˆœì„œë¥¼ ë³´ì¥
- êµ¬í˜„ì´ ê°„ë‹¨í•˜ê³  í† í”½ì´ ê³ ì •ë¨

**ë‹¨ì **:

- íŒŒí‹°ì…˜ì´ 1ê°œë¼ì„œ **ë³‘ë ¬ ì²˜ë¦¬ ë¶ˆê°€**
- ì²˜ë¦¬ëŸ‰ í™•ì¥ì— í•œê³„ê°€ ìˆìŒ

---

### 2) í† í”½ì„ ì¿ í° IDë¡œ ë¶„ë¦¬í•˜ì—¬ ì„¤ì •

- **Topic**: `outside.coupon.publish.requested.v1.{couponId}`
- **Key**: ì—†ìŒ
- **Partition ìˆ˜**: ì—¬ëŸ¬ ê°œ

ì¿ í° IDë§ˆë‹¤ **ë³„ë„ì˜ Topicì„ ìƒì„±**í•˜ì—¬ ìš”ì²­ì„ ë¼ìš°íŒ…í•œë‹¤.  
ì´ ë°©ì‹ì€ **í† í”½ ë‹¨ìœ„ë¡œ ê²©ë¦¬ë˜ë¯€ë¡œ ìˆœì°¨ì„±ê³¼ ë³‘ë ¬ ì²˜ë¦¬**ë¥¼ ëª¨ë‘ í™•ë³´í•  ìˆ˜ ìˆë‹¤.

**ì¥ì **:

- íŒŒí‹°ì…˜ì„ ììœ ë¡­ê²Œ êµ¬ì„± ê°€ëŠ¥
- ì¿ í°ë³„ë¡œ ì²˜ë¦¬ëŸ‰ì„ ë…ë¦½ì ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥

**ë‹¨ì **:

- **ë§¤ ì¿ í°ë§ˆë‹¤ í† í”½ ìƒì„±** í•„ìš”
- ìš´ì˜ ë° ê´€ë¦¬ ë³µì¡ë„ ìƒìŠ¹
- Kafka í´ëŸ¬ìŠ¤í„°ì— ê³¼ë„í•œ Topic ì¦ê°€ ìš°ë ¤

---

### ì„ íƒëœ ì „ëµ: íŒŒí‹°ì…˜ í‚¤ ë°©ì‹

ë³µì¡ë„ë¥¼ ê³ ë ¤í•˜ì—¬, ë³¸ ì‹œìŠ¤í…œì—ì„œëŠ” **"íŒŒí‹°ì…˜ í‚¤ë¥¼ ì¿ í° IDë¡œ ì„¤ì •"í•˜ëŠ” ë°©ì‹**ì„ ì±„íƒí•˜ì˜€ë‹¤.  
ì´ëŠ” ëŒ€ë¶€ë¶„ì˜ Kafka ê¸°ë°˜ ì‹œìŠ¤í…œì—ì„œ ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ë˜ë©°, **ì¼ì • ìˆ˜ì¤€ì˜ ì²˜ë¦¬ëŸ‰ê³¼ ìˆœì°¨ ì²˜ë¦¬ ë³´ì¥**ì´ ê°€ëŠ¥í•œ í˜„ì‹¤ì ì¸ ì „ëµì´ë‹¤.

---

### í† í”½ ëª… ë²„ì €ë‹ ì „ëµ

Kafkaì˜ **Partition ìˆ˜ëŠ” ìƒì„± ì´í›„ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥**í•˜ë¯€ë¡œ,  
ì²˜ë¦¬ëŸ‰ ì¦ê°€ì— ëŒ€ë¹„í•´ ë‹¤ìŒê³¼ ê°™ì€ ë²„ì €ë‹ ì „ëµì„ ì‚¬ìš©í•œë‹¤.

> ì˜ˆ : `outside.coupon.publish.requested.v1` â†’ `outside.coupon.publish.requested.v2`

**í† í”½ì„ ë²„ì „ ì—…**í•˜ì—¬ ìƒˆë¡œìš´ íŒŒí‹°ì…˜ ìˆ˜ë¥¼ ì ìš©í•˜ê³ , ê¸°ì¡´ í”„ë¡œë“€ì„œ/ì»¨ìŠˆë¨¸ë¥¼ ì ì§„ì ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í•œë‹¤.

## ğŸ—ï¸ Kafka ê¸°ë°˜ ì„¤ê³„

ì¿ í° ë°œê¸‰ ìš”ì²­ API í˜¸ì¶œ ì‹œ, Redisë¥¼ í†µí•´ **ë°œê¸‰ ê°€ëŠ¥ ì—¬ë¶€ë§Œ ì¡°íšŒ**í•˜ê³ ,  
ì¿ í° ë°œê¸‰ ìš”ì²­ ì™„ë£Œ ì´ë²¤íŠ¸ë¥¼ Kafkaì— ë°œí–‰í•˜ì—¬ **ì„ ì°©ìˆœ ì²˜ë¦¬ì™€ ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°**í•œë‹¤.

ê¸°ì¡´ì—ëŠ” Redisê°€ ì¿ í° ë°œê¸‰ ë¡œì§ ì „ë°˜ì„ ê´€ë¦¬í•˜ì˜€ìœ¼ë‚˜,  
ì´ì œëŠ” **ë‹¨ìˆœ ì¡°íšŒ ìš©ë„ë¡œë§Œ ì œí•œí•¨ìœ¼ë¡œì¨ Redisì˜ ë¶€ë‹´ì„ ì¤„ì´ê³ , Kafkaë¥¼ í†µí•´ ì²˜ë¦¬ ë¶„ì‚°ê³¼ ê³ ê°€ìš©ì„±**ì„ í™•ë³´í•œ ì„¤ê³„ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤.

### Kafka ê¸°ë°˜ ì¿ í° ë°œê¸‰ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

![img](https://github.com/user-attachments/assets/da223f07-56cb-4d81-9073-b46930387a21)

#### 1) ë°œê¸‰ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸

ì¿ í° ë°œê¸‰ ìš”ì²­ ì‹œ, Redisì—ì„œ ì¿ í° ë°œê¸‰ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ ì¡°íšŒí•œë‹¤.

- ë°œê¸‰ ê°€ëŠ¥ : ì¿ í° ë°œê¸‰ ìš”ì²­ ì™„ë£Œ ì´ë²¤íŠ¸ë¥¼ Kafkaì— ë°œí–‰í•˜ê³ , í´ë¼ì´ì–¸íŠ¸ì— ì„±ê³µ ì‘ë‹µì„ ë°˜í™˜í•œë‹¤.
- ë°œê¸‰ ë¶ˆê°€ : í´ë¼ì´ì–¸íŠ¸ì— ë°œê¸‰ ë¶ˆê°€ ì‘ë‹µì„ ë°˜í™˜í•œë‹¤.

```lua
GET coupon:available:{couponId}
```

#### 2) ì¿ í° ë°œê¸‰ ìš”ì²­ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰

Kafkaì— ì¿ í° ë°œê¸‰ ìš”ì²­ ì™„ë£Œ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•œë‹¤.  
ì´ë•Œ ì´ë²¤íŠ¸ì˜ ë°œí–‰ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ Outbox íŒ¨í„´ì„ ì‚¬ìš©í•œë‹¤.

#### 3) ì¿ í° ë°œê¸‰ ì •ë³´ ì¡°íšŒ ë° ì €ì¥

ì¿ í° ë°œê¸‰ ìš”ì²­ ì™„ë£Œ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•œ ì¿ í° ë°œê¸‰ ì„œë¹„ìŠ¤ëŠ”  
DBì—ì„œ ì¿ í° ë°œê¸‰ ì •ë³´ë¥¼ ì¡°íšŒí•˜ì—¬ ì¤‘ë³µ ì—¬ë¶€, ë°œê¸‰ ê°œìˆ˜, ë§Œë£Œì¼ ë“±ì„ í™•ì¸í•œë‹¤. (ë©±ë“±ì„± ë³´ì¥)

ë°œê¸‰ì´ ê°€ëŠ¥í•œ ê²½ìš°, ì¿ í° ë°œê¸‰ ì •ë³´ë¥¼ DBì— ì €ì¥í•œë‹¤.

#### 4) ì¿ í° ë°œê¸‰ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰

ì¿ í° ë°œê¸‰ì´ ì™„ë£Œë˜ë©´,
ë„ë©”ì¸ ì´ë²¤íŠ¸(ApplicationEvent)ë¡œ ì¿ í° ë°œê¸‰ ì™„ë£Œ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•œë‹¤.

#### 5) ì¿ í° ë°œê¸‰ ìƒíƒœ ê°±ì‹ 

ì¿ í° ë°œê¸‰ ì™„ë£Œ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•œ ì¿ í° ë°œê¸‰ ì™„ë£Œ ì„œë¹„ìŠ¤ëŠ” DBì—ì„œ ì¿ í° ë°œê¸‰ ê°œìˆ˜ë¥¼ ì¡°íšŒí•˜ë©°,  
ë°œê¸‰ ê°œìˆ˜ê°€ 0ì´ë©´, Redisì— ì¿ í° ë°œê¸‰ ìƒíƒœë¥¼ ê°±ì‹ í•œë‹¤.

```lua
SET coupon:available:{couponId} false
```

### Kafka ê¸°ë°˜ ì¿ í° ë°œê¸‰ ì‹œìŠ¤í…œ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

ìœ„ì˜ ê·¸ë¦¼ì„ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ìœ¼ë¡œ í‘œí˜„í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

```mermaid
sequenceDiagram
    autonumber
    actor í´ë¼ì´ì–¸íŠ¸
    participant ì¿ í° ìš”ì²­
    participant ì¿ í° ë°œê¸‰
    participant ì¿ í° ë°œê¸‰ ì™„ë£Œ
    participant Kafka
    participant DB
    participant Redis
    í´ë¼ì´ì–¸íŠ¸ -->>+ ì¿ í° ìš”ì²­: ì¿ í° ë°œê¸‰ ìš”ì²­ API í˜¸ì¶œ
    ì¿ í° ìš”ì²­ ->>+ Redis: ë°œê¸‰ ê°€ëŠ¥ ì—¬ë¶€ ì¡°íšŒ
    Redis -->>- ì¿ í° ìš”ì²­: ë°œê¸‰ ê°€ëŠ¥ ì—¬ë¶€ ì‘ë‹µ
    opt ë°œê¸‰ ë¶ˆê°€ëŠ¥ ?
        ì¿ í° ìš”ì²­ -->> í´ë¼ì´ì–¸íŠ¸: ë°œê¸‰ ë¶ˆê°€ ì‘ë‹µ
    end
    ì¿ í° ìš”ì²­ -->>- í´ë¼ì´ì–¸íŠ¸: ì„±ê³µ ì‘ë‹µ
    ì¿ í° ìš”ì²­ ->>+ Kafka: âœ¨ ì¿ í° ë°œê¸‰ ìš”ì²­ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰ (Outbox)
    Kafka -->>- ì¿ í° ë°œê¸‰: âœ… ì¿ í° ë°œê¸‰ ìš”ì²­ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    ì¿ í° ë°œê¸‰ ->>+ DB: ì¿ í° ë°œê¸‰ ì •ë³´ ì¡°íšŒ(ì¤‘ë³µì—¬ë¶€, ë°œê¸‰ ê°œìˆ˜, ë§Œë£Œì¼ ë“±)
    DB -->>- ì¿ í° ë°œê¸‰: ì¿ í° ë°œê¸‰ ì •ë³´ ì¡°íšŒ ì™„ë£Œ
    opt ì¿ í° ë°œê¸‰ ë¶ˆê°€ëŠ¥ ?
        ì¿ í° ë°œê¸‰ -->> ì¿ í° ë°œê¸‰: âš¡ ì¿ í° ë°œê¸‰ ì‹¤íŒ¨ ì˜ˆì™¸
    end

    ì¿ í° ë°œê¸‰ -->>+ DB: ì¿ í° ë°œê¸‰ ì •ë³´ ì €ì¥
    DB -->>- ì¿ í° ë°œê¸‰: ì¿ í° ë°œê¸‰ ì •ë³´ ì €ì¥ ì™„ë£Œ
    ì¿ í° ë°œê¸‰ -->>+ Kafka: âœ¨ ì¿ í° ë°œê¸‰ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰ (Outbox)
    Kafka -->>- ì¿ í° ë°œê¸‰ ì™„ë£Œ: âœ… ì¿ í° ë°œê¸‰ ì™„ë£Œ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
    ì¿ í° ë°œê¸‰ ì™„ë£Œ ->>+ DB: ì¿ í° ë°œê¸‰ ê°œìˆ˜ ì¡°íšŒ
    DB -->>- ì¿ í° ë°œê¸‰ ì™„ë£Œ: ì¿ í° ë°œê¸‰ ê°œìˆ˜ ì¡°íšŒ ì™„ë£Œ
    opt ì¿ í° ë°œê¸‰ ì¢…ë£Œ ?
        ì¿ í° ë°œê¸‰ ì™„ë£Œ -->>+ Redis: ì¿ í° ë°œê¸‰ ìƒíƒœ ê°±ì‹ 
    end 
```

## âœ¨ Kafka ê¸°ë°˜ êµ¬í˜„

### 1) ì¿ í° ë°œê¸‰ ìš”ì²­ ì„œë¹„ìŠ¤

ì¿ í° ë°œê¸‰ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  **ì¿ í° ë°œê¸‰ ìš”ì²­ ì™„ë£Œ ì´ë²¤íŠ¸**(Kafka ì´ë²¤íŠ¸ - Outbox)ë¥¼ Kafkaì— ë°œí–‰í•˜ëŠ” ì„œë¹„ìŠ¤ì´ë‹¤.

```java
public class CouponService {

    public void requestPublishUserCoupon(CouponCommand.Publish command) {
        boolean publishable = couponRepository.findPublishableCouponById(command.getCouponId());

        if (!publishable) {
            throw new IllegalArgumentException("ë°œê¸‰ ë¶ˆê°€í•œ ì¿ í°ì…ë‹ˆë‹¤.");
        }

        CouponEvent.PublishRequested event = CouponEvent.PublishRequested.of(command.getUserId(), command.getCouponId());
        couponEventPublisher.publishRequested(event);
    }
}
```

ì´ ë©”ì„œë“œëŠ” `@Transactional`ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— `OutboxEvent.Manual`ë¡œ ë°œí–‰ë˜ë©°,  
`@Async + @EventListener` ë°©ì‹ìœ¼ë¡œ Outboxë¥¼ DBì— ì €ì¥í•˜ê³  Kafkaì— ë°œí–‰í•œë‹¤.

> ìì„¸í•œ ë‚´ìš©ì€ [Kafka - Outbox íŒ¨í„´ ì ìš©](/docs/study/01.Kafka.md) ì°¸ê³ 

#### ì¿ í° ë°œê¸‰ ìš”ì²­ ë„ë©”ì¸ ì´ë²¤íŠ¸ ë°œí–‰

```java
public class CouponEventPublisherImpl implements CouponEventPublisher {

    private final OutboxEventPublisher outboxEventPublisher;

    @Override
    public void publishRequested(CouponEvent.PublishRequested event) {
        outboxEventPublisher.publishManualEvent(EventType.COUPON_PUBLISH_REQUESTED, event.getCouponId(), event);
    }
}
```

#### ì•„ì›ƒë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ

```java
public class OutboxEventListener {

    private final OutboxService outboxService;

    @Async
    @EventListener
    public void handle(OutboxEvent.Manual event) {
        log.info("produceEvent - Manual ì•„ì›ƒ ë°•ìŠ¤ ì´ë²¤íŠ¸ ìˆ˜ì‹ : {}", event.getOutbox().getTopic());
        outboxService.createOutbox(event.getOutbox());
        outboxService.produceEvent(event.getOutbox());
    }
}
```

### 2) ì¿ í° ë°œê¸‰ ìš”ì²­ ì™„ë£Œ ì´ë²¤íŠ¸ ìˆ˜ì‹ 

Kafkaë¥¼ í†µí•´ ë°œí–‰ëœ ì´ë²¤íŠ¸ë¥¼ `@KafkaListener`ê°€ ìˆ˜ì‹ í•˜ì—¬
ì¿ í° ë°œê¸‰ì„ ì§„í–‰í•˜ê³ , ì™„ë£Œë˜ë©´ offsetì„ ìˆ˜ë™ ì»¤ë°‹í•œë‹¤.

```java
public class CouponMessageEventListener {

    @KafkaListener(topics = Topic.COUPON_PUBLISH_REQUESTED, groupId = GroupId.COUPON)
    public void handle(String message, Acknowledgment ack) {
        log.info("ì¿ í° ë°œê¸‰ ìš”ì²­ ì´ë²¤íŠ¸ ìˆ˜ì‹  {}", message);

        Event<CouponEvent.PublishRequested> event = Event.of(message, CouponEvent.PublishRequested.class);
        CouponEvent.PublishRequested payload = event.getPayload();

        couponService.publishUserCoupon(CouponCommand.Publish.of(payload.getUserId(), payload.getCouponId()));
        ack.acknowledge();
    }
}
```

### 3) ì¿ í° ë°œê¸‰

ì¤‘ë³µ ë°œê¸‰ì„ ë°©ì§€í•˜ê³ , ì¿ í° ê°œìˆ˜ ë° ë§Œë£Œì¼ ë“±ì„ ê²€ì¦í•œ í›„ ë°œê¸‰ì„ ì§„í–‰í•œë‹¤.  
ì •ìƒ ë°œê¸‰ í›„ì—ëŠ” ë„ë©”ì¸ ì´ë²¤íŠ¸ë¡œ ë°œê¸‰ ì™„ë£Œ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•œë‹¤.

```java
public class CouponService {

    @Transactional
    public void publishUserCoupon(CouponCommand.Publish command) {
        couponRepository.findByUserIdAndCouponId(command.getUserId(), command.getCouponId())
            .ifPresent(coupon -> {
                throw new IllegalArgumentException("ì´ë¯¸ ë°œê¸‰ëœ ì¿ í°ì…ë‹ˆë‹¤.");
            });

        Coupon coupon = couponRepository.findCouponById(command.getCouponId());
        coupon.publish();

        UserCoupon userCoupon = UserCoupon.create(command.getUserId(), command.getCouponId());
        couponRepository.save(userCoupon);

        CouponEvent.Published event = CouponEvent.Published.of(coupon);
        couponEventPublisher.published(event);
    }
}
```

### 4) ì¿ í° ë°œê¸‰ ì™„ë£Œ ì´ë²¤íŠ¸ ìˆ˜ì‹ 

ë°œê¸‰ ì™„ë£Œ ë„ë©”ì¸ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•˜ì—¬, Redis ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ” ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤.

```java
public class CouponEventListener {

    private final CouponService couponService;

    @Async
    @TransactionalEventListener
    public void handle(CouponEvent.Published event) {
        log.info("ì¿ í° ë°œí–‰ ì´ë²¤íŠ¸ ìˆ˜ì‹  - ì¿ í° ë°œí–‰");
        couponService.stopPublishCoupon(event.getId());
    }
}
```

### 5) ì¿ í° ë°œê¸‰ ìƒíƒœ ê°±ì‹ 

DBì—ì„œ ì¿ í° ìƒíƒœë¥¼ ì¡°íšŒí•˜ê³ , ë” ì´ìƒ ë°œê¸‰ ë¶ˆê°€ëŠ¥í•  ê²½ìš° Redis ìƒíƒœë¥¼ ë³€ê²½í•œë‹¤.

```java
public class CouponService {

    @Transactional(readOnly = true)
    public void stopPublishCoupon(Long couponId) {
        Coupon coupon = couponRepository.findCouponById(couponId);

        if (coupon.isNotPublishable()) {
            couponRepository.updateAvailableCoupon(couponId, false);
        }
    }
}
```

## ğŸ§ª í…ŒìŠ¤íŠ¸

Kafka ê¸°ë°˜ ì¿ í° ë°œê¸‰ ì‹œìŠ¤í…œì˜
í…ŒìŠ¤íŠ¸ëŠ” [Awaitility](https://testcontainers.com/guides/testing-spring-boot-kafka-listener-using-testcontainers/#_write_test_for_kafka_listener)
ë¥¼ í™œìš©í•˜ì—¬ ì§„í–‰í•˜ì˜€ë‹¤.    
ì¿ í° ë°œê¸‰ ì™„ë£Œ ì´ë²¤íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ë°œí–‰ë˜ê³ , DBì— ì €ì¥ë˜ì—ˆëŠ”ì§€ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê²€ì¦í•œë‹¤.

```java
class CouponControllerE2ETest extends E2EControllerTestSupport {

    @DisplayName("ì¿ í°ì„ ë°œê¸‰í•œë‹¤.")
    @Test
    void publishCoupon() {
        // given
        Coupon coupon = Coupon.create("ì¿ í°ëª…1", 0.1, 10, CouponStatus.PUBLISHABLE, LocalDateTime.now().plusDays(1));
        couponRepository.save(coupon);
        couponRepository.updateAvailableCoupon(coupon.getId(), true);

        CouponRequest.Publish request = CouponRequest.Publish.of(coupon.getId());

        // when & then
        given()
            .contentType(ContentType.JSON)
            .body(request)
            .when()
            .post("/api/v1/users/{id}/coupons/publish", user.getId())
            .then()
            .log().all()
            .statusCode(HttpStatus.OK.value())
            .body("code", equalTo(200))
            .body("message", equalTo("OK"));

        await()
            .atMost(30, TimeUnit.SECONDS)
            .pollInterval(Duration.ofMillis(500))
            .untilAsserted(() -> {
                Optional<UserCoupon> result = couponRepository.findByUserIdAndCouponId(user.getId(), coupon.getId());
                assertThat(result).isPresent();
            });
    }
}
```

### í…ŒìŠ¤íŠ¸ ì„¤ëª… ë° í™•ì¸

`Awaitility`ë¥¼ ì‚¬ìš©í•˜ì—¬ **30ì´ˆ ì´ë‚´, 500ms ê°„ê²©**ìœ¼ë¡œ í´ë§í•˜ì—¬ ì¿ í° ë°œê¸‰ ì™„ë£Œ ì—¬ë¶€ë¥¼ ê²€ì¦í•œë‹¤.

í•´ë‹¹ í…ŒìŠ¤íŠ¸ëŠ” **ì¿ í° ë°œê¸‰ ì™„ë£Œ ì´ë²¤íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆëŠ”ì§€**ì™€ í•¨ê»˜,  
**ë°œê¸‰ ê°€ëŠ¥ ìˆ˜ëŸ‰ì´ 1ê°œì¼ ê²½ìš°**, Redisì˜ ë°œê¸‰ ìƒíƒœ (`coupon:available:{couponId}`)ê°€ `false`ë¡œ ê°±ì‹ ë˜ì—ˆëŠ”ì§€ë¥¼ í™•ì¸í•˜ëŠ” **E2E í…ŒìŠ¤íŠ¸**ì´ë‹¤.

### í…ŒìŠ¤íŠ¸ ê²°ê³¼

ì•„ë˜ ì´ë¯¸ì§€ì²˜ëŸ¼ ì¿ í° ë°œê¸‰ ì´ë²¤íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ë°œí–‰ë˜ê³ ,
í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![img_1](https://github.com/user-attachments/assets/d282f4ca-69aa-47a2-97e3-4bc773a9a23b)

## ğŸ†š Redis ê¸°ë°˜ vs Kafka ê¸°ë°˜ ì‹œìŠ¤í…œ ë¹„êµ

| í•­ëª©            | Redis ê¸°ë°˜          | Kafka ê¸°ë°˜        |
|---------------|-------------------|-----------------|
| **ì²˜ë¦¬ ë°©ì‹**     | ì´ë²¤íŠ¸ ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬     | ì´ë²¤íŠ¸ ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬   |
| **ë°œê¸‰ ì§€ì—°**     | í‰ê·  1ë¶„ (ë°°ì¹˜ ì˜ì¡´)     | ì‹¤ì‹œê°„ ë°œê¸‰ ê°€ëŠ¥       |
| **DB ë¶€í•˜**     | ë°°ì¹˜ ê¸°ë°˜ Bulk Insert | ë°œê¸‰ ë‹¨ê±´ ì²˜ë¦¬ë¡œ ë¶„ì‚°    |
| **Redis ì‚¬ìš©ëŸ‰** | ì¿ í° ë°œê¸‰ ìš”ì²­ ì •ë³´ ì „ì²´ ì €ì¥ | ë°œê¸‰ ê°€ëŠ¥ ì—¬ë¶€ ì¡°íšŒë§Œ ì‚¬ìš© |
| **ìš´ì˜ í¸ì˜ì„±**    | ë°°ì¹˜ ê´€ë¦¬ í•„ìš”          | ë°°ì¹˜ ì œê±°ë¡œ ìš´ì˜ ë‹¨ìˆœí™”   |

Kafka ê¸°ë°˜ ì‹œìŠ¤í…œì€ ì„±ëŠ¥ë¿ ì•„ë‹ˆë¼ **ìš´ì˜ íš¨ìœ¨ì„±**ê³¼ **ì‚¬ìš©ì ê²½í—˜(UX)** í–¥ìƒê¹Œì§€ ë™ì‹œì— ë‹¬ì„±í•˜ì˜€ë‹¤.

## ğŸ ê²°ë¡ 

Kafka ê¸°ë°˜ ì•„í‚¤í…ì²˜ë¥¼ ë„ì…í•¨ìœ¼ë¡œì¨ ë‹¤ìŒê³¼ ê°™ì€ íš¨ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤.

- **ì¦‰ì‹œ ë°œê¸‰ ê°€ëŠ¥**í•œ ì‚¬ìš©ì ì¹œí™”ì ì¸ ì¿ í° ì‹œìŠ¤í…œ êµ¬í˜„
- **ë°°ì¹˜ ì œê±°**ë¥¼ í†µí•œ ìš´ì˜ ê°„ì†Œí™” ë° ì¥ì•  ì§€ì  ê°ì†Œ
- **DB ë° Redisì˜ ë¶€í•˜ ê°ì†Œ**, ì‹œìŠ¤í…œ ì „ë°˜ì˜ ì•ˆì •ì„± í™•ë³´
- **Outbox íŒ¨í„´ê³¼ ë©±ë“±ì„± ë³´ì¥**ìœ¼ë¡œ ë©”ì‹œì§€ ì‹ ë¢°ì„± í–¥ìƒ

ê²°ê³¼ì ìœ¼ë¡œ **ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ì˜ í•µì‹¬ ìš”ê±´ì¸ ë™ì‹œì„± ì œì–´ì™€ ê³ ê°€ìš©ì„±**ì„ ë§Œì¡±í•  ìˆ˜ ìˆëŠ” ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ì˜€ë‹¤.



# Kafka

## ğŸ›°ï¸ Kafkaë€?

KafkaëŠ” ëŒ€ìš©ëŸ‰ ë°ì´í„°ë¥¼ ë¹ ë¥´ê²Œ ì²˜ë¦¬í•˜ê³ , ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°ì„ ì§€ì›í•˜ëŠ” **ë¶„ì‚° ë©”ì‹œì§• ì‹œìŠ¤í…œ**ì´ë‹¤.


## â“ Kafkaë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ 

KafkaëŠ” **ëŒ€ê·œëª¨ íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ì‹œìŠ¤í…œ** ë˜ëŠ” **MSA** í™˜ê²½ì—ì„œ **ë†’ì€ ì„±ëŠ¥, ìœ ì—°í•œ í™•ì¥ì„±, ê³ ê°€ìš©ì„±**ì„ ì œê³µí•œë‹¤.  
ë˜í•œ, ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ë¥¼ êµ¬í˜„í•˜ì—¬ **ì„œë¹„ìŠ¤ ê°„ ëŠìŠ¨í•œ ê²°í•©**ì„ ê°€ëŠ¥í•˜ê²Œ í•œë‹¤.

Kafkaë¥¼ ì‚¬ìš©í•˜ëŠ” ì£¼ìš” ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

- **ë†’ì€ ì²˜ë¦¬ëŸ‰**: íŒŒí‹°ì…˜ ê¸°ë°˜ ë³‘ë ¬ ì²˜ë¦¬ êµ¬ì¡°ë¡œ ì´ˆë‹¹ ìˆ˜ì‹­ë§Œ ê±´ì˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ ê°€ëŠ¥
- **ë‚´êµ¬ì„± ë³´ì¥**: ë©”ì‹œì§€ë¥¼ ë””ìŠ¤í¬ì— ì €ì¥í•˜ê³  ë³µì œí•˜ì—¬ ë°ì´í„° ì†ì‹¤ ë°©ì§€
- **ìˆœì„œ ë³´ì¥**: ê°™ì€ íŒŒí‹°ì…˜ ë‚´ì—ì„œëŠ” ë©”ì‹œì§€ ìˆœì„œë¥¼ ë³´ì¥

ìœ„ì™€ ê°™ì€ ì¥ì ì„ í†µí•´ KafkaëŠ” ë‹¤ì–‘í•œ ì‹¤ì‹œê°„ ë°ì´í„° ì²˜ë¦¬ ì‹œìŠ¤í…œì—ì„œ í•µì‹¬ ì¸í”„ë¼ë¡œ ì‚¬ìš©ë˜ê³  ìˆë‹¤.

## âš¡ï¸ Kafka êµ¬ì„± ìš”ì†Œ

KafkaëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì£¼ìš” êµ¬ì„± ìš”ì†Œë“¤ë¡œ ì´ë£¨ì–´ì ¸ ìˆë‹¤.

---

### Broker (ë¸Œë¡œì»¤)

**Broker**ëŠ” í•˜ë‚˜ì˜ Kafka ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì˜ë¯¸í•œë‹¤.  
Producerë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•˜ê³ , **offset**ì„ ê¸°ì¤€ìœ¼ë¡œ ë””ìŠ¤í¬ì— ì €ì¥í•œë‹¤.  
Consumerì˜ ìš”ì²­ì— ë”°ë¼ ì €ì¥ëœ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

---

### Producer (í”„ë¡œë“€ì„œ)

**Producer**ëŠ” ë©”ì‹œì§€ë¥¼ ë¸Œë¡œì»¤ì— **ë°œí–‰(Publish)** í•˜ëŠ” ì—­í• ì„ í•œë‹¤.  
ê¸°ë³¸ì ìœ¼ë¡œ KafkaëŠ” ì–´ë–¤ Partitionì— ë©”ì‹œì§€ë¥¼ ê¸°ë¡í• ì§€ ìë™ìœ¼ë¡œ ê²°ì •í•˜ì§€ë§Œ,  
**key ê¸°ë°˜ ë¼ìš°íŒ…** ë˜ëŠ” **ì‚¬ìš©ì ì •ì˜ Partitioner**ë¥¼ í†µí•´ íŠ¹ì • Partitionìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆë‹¤.

---

### Consumer (ì»¨ìŠˆë¨¸)

**Consumer**ëŠ” Kafka Brokerì— ì €ì¥ëœ ë©”ì‹œì§€ë¥¼ **ì†Œë¹„(Consume)** í•˜ëŠ” ì—­í• ì„ í•œë‹¤.  
í•˜ë‚˜ ì´ìƒì˜ Topicì„ êµ¬ë…í•˜ë©°, **ê° Partition ë‹¨ìœ„ë¡œ offsetì„ ê´€ë¦¬**í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì½ëŠ”ë‹¤.

- **Current Offset**: í˜„ì¬ ì½ê³  ìˆëŠ” ë©”ì‹œì§€ì˜ ìœ„ì¹˜
- **Committed Offset**: ì‹¤ì œë¡œ ì²˜ë¦¬ ì™„ë£Œëœ ë©”ì‹œì§€ì˜ ìœ„ì¹˜

> offsetì„ ì ì ˆíˆ ê´€ë¦¬í•˜ì§€ ì•Šìœ¼ë©´ ë©”ì‹œì§€ ì¤‘ë³µ ì†Œë¹„ ë˜ëŠ” ìœ ì‹¤ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

---

### Topic (í† í”½)

**Topic**ì€ Kafka ë©”ì‹œì§€ë¥¼ ë¶„ë¥˜í•˜ëŠ” ë…¼ë¦¬ì  ë‹¨ìœ„ì´ë‹¤.  
í•˜ë‚˜ì˜ Topicì€ ì—¬ëŸ¬ ê°œì˜ Partitionìœ¼ë¡œ êµ¬ì„±ë˜ë©°,  
ProducerëŠ” Topic ë‹¨ìœ„ë¡œ ë©”ì‹œì§€ë¥¼ ë°œí–‰í•˜ê³ , ConsumerëŠ” Topicì„ êµ¬ë…í•˜ì—¬ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•œë‹¤.

---

### Partition (íŒŒí‹°ì…˜)

**Partition**ì€ Topicì„ êµ¬ì„±í•˜ëŠ” ë¬¼ë¦¬ì  ë‹¨ìœ„ì´ë‹¤.  
ê° Partitionì€ **ë©”ì‹œì§€ ìˆœì„œë¥¼ ë³´ì¥**í•˜ë©°, ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•œë‹¤.

> ë™ì¼í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ë™ì‹œì— ì²˜ë¦¬í•˜ë©´ ì•ˆ ë  ê²½ìš°, í•´ë‹¹ ë¦¬ì†ŒìŠ¤ë¥¼ Partition Keyë¡œ ì§€ì •í•˜ì—¬ **ë™ì‹œì„± ì œì–´**ì™€ **ìˆœì°¨ ì²˜ë¦¬**ë¥¼ ë³´ì¥í•  ìˆ˜ ìˆë‹¤.

---
### Consumer Group (ì»¨ìŠˆë¨¸ ê·¸ë£¹)

**Consumer Group**ì€ í•˜ë‚˜ì˜ Topicì„ **ì—¬ëŸ¬ Consumerê°€ ë³‘ë ¬ë¡œ ì²˜ë¦¬**í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í•˜ëŠ” ë‹¨ìœ„ì´ë‹¤.  
í•˜ë‚˜ì˜ Partitionì€ ì˜¤ì§ í•˜ë‚˜ì˜ Consumerì—ê²Œë§Œ í• ë‹¹ë˜ë¯€ë¡œ,  
Consumer Groupì„ í†µí•´ ë™ì¼í•œ ë©”ì‹œì§€ë¥¼ ì¤‘ë³µ ì†Œë¹„í•˜ì§€ ì•Šìœ¼ë©´ì„œ **ì²˜ë¦¬ ë¶€í•˜ë¥¼ ë¶„ì‚°**í•  ìˆ˜ ìˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, `ì£¼ë¬¸ ì™„ë£Œ` ë©”ì‹œì§€ë¥¼ ê²°ì œ ì„œë¹„ìŠ¤, ë°°ì†¡ ì„œë¹„ìŠ¤ ë“± **ì„œë¡œ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ë“¤ì´ ë…ë¦½ì ìœ¼ë¡œ ì†Œë¹„**í•˜ê³ ì í•  ë•Œ ê°ê°ì˜ Consumer Groupì„ êµ¬ì„±í•œë‹¤.

> ì¼ë°˜ì ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‹¨ìœ„ë¡œ Consumer Groupì„ ìƒì„±í•œë‹¤.

---

### Rebalancing (ë¦¬ë°¸ëŸ°ì‹±)

**Rebalancing**ì€ Consumer Group ë‚´ì—ì„œ Partitionì˜ ì†Œìœ ê¶Œì´ ë³€ê²½ë˜ëŠ” ê³¼ì •ì´ë‹¤.  
ë‹¤ìŒê³¼ ê°™ì€ ìƒí™©ì—ì„œ ìë™ìœ¼ë¡œ ë°œìƒí•œë‹¤.

- Consumer Groupì— ìƒˆë¡œìš´ Consumerê°€ ì¶”ê°€ë  ë•Œ
- ê¸°ì¡´ Consumerê°€ ì¥ì• ë¡œ ì¸í•´ ì‚¬ë¼ì§ˆ ë•Œ
- Topicì— ìƒˆë¡œìš´ Partitionì´ ì¶”ê°€ë  ë•Œ

Rebalancingì€ Kafkaì˜ **í™•ì¥ì„±ê³¼ ê°€ìš©ì„±ì„ ë†’ì´ëŠ” í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜**ì´ì§€ë§Œ,  
ì§„í–‰ ì¤‘ì—ëŠ” ì¼ì‹œì ì¸ ë©”ì‹œì§€ ì†Œë¹„ ì¤‘ë‹¨ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

---

### Cluster (í´ëŸ¬ìŠ¤í„°)

**Cluster**ëŠ” ì—¬ëŸ¬ Brokerë¥¼ í•˜ë‚˜ì˜ ë…¼ë¦¬ì  ë‹¨ìœ„ë¡œ ë¬¶ì–´ **ê³ ê°€ìš©ì„±ê³¼ í™•ì¥ì„±**ì„ ì œê³µí•œë‹¤.  
Brokerë¥¼ ìˆ˜í‰ì ìœ¼ë¡œ í™•ì¥í•¨ìœ¼ë¡œì¨ ë©”ì‹œì§€ ìˆ˜ì‹  ë° ì €ì¥ì„ ë¶„ì‚°í•  ìˆ˜ ìˆìœ¼ë©°,  
**ìš´ì˜ ì¤‘ì¸ Brokerì— ì˜í–¥ì„ ì£¼ì§€ ì•Šê³  ìœ ì—°í•˜ê²Œ ì¦ì„¤**ì´ ê°€ëŠ¥í•˜ë‹¤.

---

### Replication (ë ˆí”Œë¦¬ì¼€ì´ì…˜)

**Replication**ì€ Kafkaì˜ **ë°ì´í„° ë‚´êµ¬ì„±**ì„ í™•ë³´í•˜ê¸° ìœ„í•œ í•µì‹¬ ê¸°ëŠ¥ì´ë‹¤.  
ê° Partitionì€ í•˜ë‚˜ì˜ **Leader Replica**ì™€ ì—¬ëŸ¬ ê°œì˜ **Follower Replica**ë¡œ êµ¬ì„±ëœë‹¤.

- **Leader Replica**: ë©”ì‹œì§€ì˜ ì“°ê¸°/ì½ê¸°ë¥¼ ë‹´ë‹¹í•˜ë©°, ë‹¨ í•˜ë‚˜ë§Œ ì¡´ì¬í•œë‹¤.
- **Follower Replica**: Leaderì˜ ë°ì´í„°ë¥¼ ë³µì œí•˜ì—¬ ë°±ì—… ì—­í• ì„ ìˆ˜í–‰í•˜ë©°, ì¥ì•  ë°œìƒ ì‹œ ë™ê¸°í™”ëœ Followerê°€ Leaderë¡œ ìŠ¹ê²©ëœë‹¤.

> Leaderì™€ ë™ê¸°í™”ë˜ì§€ ì•Šì€ FollowerëŠ” Leaderë¡œ ìŠ¹ê²©ë  ìˆ˜ ì—†ë‹¤.

![img_1](https://github.com/user-attachments/assets/7f4b42ea-cff8-49ee-826a-796c1b12dd3f)


## ğŸ” Kafka êµ¬ì„± ìš”ì†Œì˜ íë¦„

ì¹´í”„ì¹´ì˜ ì£¼ìš” êµ¬ì„± ìš”ì†ŒëŠ” ë©”ì‹œì§€ì˜ **ë°œí–‰, ì €ì¥, ì†Œë¹„** ê³¼ì •ì„ ìˆœì°¨ì ìœ¼ë¡œ ë‹´ë‹¹í•˜ë©°, ê·¸ íë¦„ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

1. **Producer**ëŠ” ë©”ì‹œì§€ë¥¼ íŠ¹ì • **Topic**ì— ë°œí–‰í•œë‹¤.
2. **Broker**ëŠ” ìˆ˜ì‹ í•œ ë©”ì‹œì§€ë¥¼ ì§€ì •ëœ **Partition**ì— ì €ì¥í•œë‹¤.
3. **Consumer**ëŠ” Topicì„ êµ¬ë…í•˜ê³ , í• ë‹¹ëœ Partitionìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ì†Œë¹„í•œë‹¤.

### íŒŒí‹°ì…˜ê³¼ ì»¨ìŠˆë¨¸ ê°„ì˜ ê´€ê³„

ì¹´í”„ì¹´ì˜ ë³‘ë ¬ ì²˜ë¦¬ ì„±ëŠ¥ê³¼ ë¦¬ì†ŒìŠ¤ í™œìš©ë„ëŠ” **Partition ìˆ˜ì™€ Consumer ìˆ˜ì˜ ë¹„ìœ¨**ì— ë”°ë¼ ë‹¬ë¼ì§„ë‹¤.

> í”„ë¡œë“€ì„œ ìˆ˜ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì„±ëŠ¥ê³¼ ë¬´ê´€í•˜ë©°, ë¸Œë¡œì»¤ì—ê²Œ ì–¼ë§ˆë‚˜ ì˜ ë°œí–‰í•˜ëŠ”ì§€ê°€ ì¤‘ìš”í•˜ë‹¤.

---

#### 1) íŒŒí‹°ì…˜ ìˆ˜ > ì»¨ìŠˆë¨¸ ìˆ˜

ì´ ê²½ìš°, **í•˜ë‚˜ì˜ Consumerê°€ ì—¬ëŸ¬ Partitionì„ ë‹´ë‹¹**í•˜ê²Œ ëœë‹¤.    
ë©”ì‹œì§€ ì²˜ë¦¬ëŠ” ìˆœì°¨ì ìœ¼ë¡œ ì´ë£¨ì–´ì§€ë¯€ë¡œ ì²˜ë¦¬ ì†ë„ê°€ ëŠë ¤ì§ˆ ìˆ˜ ìˆì§€ë§Œ, ì´ë¥¼ **ì˜ë„ì ìœ¼ë¡œ ì§€ì—°ì‹œì¼œ(throttling)**    
DBì— ê³¼ë„í•œ ë¶€í•˜ê°€ ê±¸ë¦¬ì§€ ì•Šë„ë¡ ì¡°ì ˆí•  ìˆ˜ ìˆë‹¤.

> âœ… DBì— íŠ¸ë˜í”½ì„ ë¶„ì‚°ì‹œí‚¤ê³ ì í•  ë•Œ ìœ ìš©í•˜ë‹¤.

![img_2](https://github.com/user-attachments/assets/11d7932d-bae2-4077-ab83-b56f90afdd6d)


---

#### 2) íŒŒí‹°ì…˜ ìˆ˜ = ì»¨ìŠˆë¨¸ ìˆ˜

**ê° Consumerê°€ í•˜ë‚˜ì˜ Partitionì„ ì „ë‹´**í•˜ëŠ” ê°€ì¥ ì´ìƒì ì¸ êµ¬ì¡°ë‹¤.  
ëª¨ë“  Partitionì´ ë³‘ë ¬ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ **ìµœëŒ€ ì²˜ë¦¬ ì„±ëŠ¥**ì„ í™•ë³´í•  ìˆ˜ ìˆë‹¤.

> âœ… ì²˜ë¦¬ëŸ‰ ê·¹ëŒ€í™”ê°€ í•„ìš”í•œ í™˜ê²½ì— ì í•©í•˜ë‹¤. 

![img_3](https://github.com/user-attachments/assets/758031b0-9df0-49f5-bf14-9afdb248b7ba)


---

#### 3) íŒŒí‹°ì…˜ ìˆ˜ < ì»¨ìŠˆë¨¸ ìˆ˜

ì¼ë¶€ ConsumerëŠ” í• ë‹¹ë°›ì„ Partitionì´ ì—†ì–´ **ìœ íœ´ ìƒíƒœ(idle)** ë¡œ ëŒ€ê¸°í•˜ê²Œ ëœë‹¤.  
ì´ëŸ¬í•œ ConsumerëŠ” **ì¥ì•  ë°œìƒ ì‹œ ìë™ ë¦¬ë°¸ëŸ°ì‹±**ì„ í†µí•´ **ëŒ€ì²´ Consumer**ë¡œ ì „í™˜ë  ìˆ˜ ìˆì–´, ê³ ê°€ìš©ì„± í™•ë³´ì— ê¸°ì—¬í•œë‹¤.

> âœ… ì¥ì•  ë³µêµ¬ ë° ë¦¬ë°¸ëŸ°ì‹±ì„ ê³ ë ¤í•œ ì—¬ìœ  ì „ëµìœ¼ë¡œ í™œìš© ê°€ëŠ¥í•˜ë‹¤. 

![img_4](https://github.com/user-attachments/assets/c6702173-11df-44aa-937f-af46e23d94e8)



## âš ï¸ Kafka ì£¼ì˜ì‚¬í•­

Kafkaì˜ ê³ ê°€ìš©ì„±ê³¼ í™•ì¥ì„±ì„ ì œëŒ€ë¡œ í™œìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì£¼ì˜ì‚¬í•­ì„ ê³ ë ¤í•´ì•¼ í•œë‹¤.

---

### ë©”ì‹œì§€ ìœ ì‹¤ ë°©ì§€

ë„ë©”ì¸ ë¡œì§ì´ ì™„ë£Œëœ í›„ ì´ë²¤íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ë°œí–‰ë˜ì§€ ì•Šìœ¼ë©´, í•´ë‹¹ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•˜ëŠ” Consumerê°€ ë¡œì§ì„ ìˆ˜í–‰í•  ìˆ˜ ì—†ì–´ **ì „ì²´ ì‹œìŠ¤í…œì˜ ì •í•©ì„±ì´ ê¹¨ì§ˆ ìˆ˜ ìˆë‹¤**.  
ì´ëŸ¬í•œ ìƒí™©ì„ ë°©ì§€í•˜ê¸° ìœ„í•´, ì„œë¹„ìŠ¤ ë¡œì§ê³¼ ì´ë²¤íŠ¸ ë°œí–‰ì„ **ì›ìì ìœ¼ë¡œ í•¨ê»˜ ì‹¤í–‰**í•´ì•¼ í•˜ë©°, ì´ë¥¼ **íŠ¸ëœì­ì…”ë„ ë©”ì‹œì§•(Transactional Messaging)** ì´ë¼ê³  í•œë‹¤.

íŠ¸ëœì­ì…”ë„ ë©”ì‹œì§•ì„ êµ¬í˜„í•˜ëŠ” ëŒ€í‘œì ì¸ ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ë‹¤:

- **Outbox íŒ¨í„´**: ë„ë©”ì¸ ë¡œì§ê³¼ ì´ë²¤íŠ¸ ë°œí–‰ì„ ë¶„ë¦¬í•˜ì—¬, ì´ë²¤íŠ¸ë¥¼ Outbox í…Œì´ë¸”ì— ë¨¼ì € ì €ì¥í•œ ë’¤, ë³„ë„ì˜ í”„ë¡œì„¸ìŠ¤ê°€ ì´ë¥¼ Kafkaë¡œ ë°œí–‰í•œë‹¤.
- **Change Data Capture (CDC)**: ë°ì´í„°ë² ì´ìŠ¤ì˜ ë³€ê²½ ì‚¬í•­ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì§€í•˜ì—¬ Kafka ì´ë²¤íŠ¸ë¡œ ë³€í™˜ ë° ì „ì†¡í•˜ëŠ” ë°©ì‹ì´ë‹¤.

> Outbox íŒ¨í„´ì„ ì‚¬ìš©í•˜ë©´ ë„ë©”ì¸ ë¡œì§ ë‚´ì—ì„œ ì´ë²¤íŠ¸ê°€ ê¸°ë¡ë˜ë¯€ë¡œ, ë„ë©”ì¸ ê°„ ê²°í•©ë„ê°€ ë†’ì•„ì§ˆ ìˆ˜ ìˆë‹¤.  
> ë³¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” ì´ëŸ¬í•œ ê²°í•©ì„ ìµœì†Œí™”í•˜ê¸° ìœ„í•œ Outbox êµ¬í˜„ ì „ëµì„ ì ìš©í•˜ì˜€ë‹¤.

---

### ë©”ì‹œì§€ ì¤‘ë³µ ì²˜ë¦¬

KafkaëŠ” ë¦¬ë°¸ëŸ°ì‹± ë“± ë‚´ë¶€ ì´ë²¤íŠ¸ë¡œ ì¸í•´ **ë©”ì‹œì§€ë¥¼ ì¤‘ë³µ ì†Œë¹„í•  ìˆ˜ ìˆë‹¤**.  
ë”°ë¼ì„œ ë„ë©”ì¸ ë¡œì§ì€ ì¤‘ë³µëœ ë©”ì‹œì§€ê°€ ë“¤ì–´ì˜¤ë”ë¼ë„ **ë™ì¼í•œ ê²°ê³¼ë¥¼ ë³´ì¥í•  ìˆ˜ ìˆë„ë¡ ë©±ë“±ì„±(Idempotency)** ì„ ê°€ì ¸ì•¼ í•œë‹¤.  
ì´ëŸ¬í•œ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì „ëµ ì¤‘ í•˜ë‚˜ê°€ **Inbox íŒ¨í„´**ì´ë‹¤.

---

### ë©”ì‹œì§€ ì‹¤íŒ¨ ëŒ€ì‘

Kafka ë©”ì‹œì§€ë¥¼ ì†Œë¹„í•˜ëŠ” ê³¼ì •ì—ì„œ, ì—­ì§ë ¬í™” ì˜¤ë¥˜ ë˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì˜ˆì™¸ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.  
ì´ëŸ¬í•œ ì‹¤íŒ¨ì— ëŒ€ë¹„í•´ **Dead Letter Queue(DLQ)** ë¥¼ êµ¬ì„±í•˜ë©´, ì‹¤íŒ¨í•œ ë©”ì‹œì§€ë¥¼ ë³„ë„ì˜ í† í”½ì— ì €ì¥í•˜ì—¬ ì´í›„ ì¬ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

## ğŸ“ª Outbox íŒ¨í„´ êµ¬í˜„

Outbox íŒ¨í„´ì€ Kafka ì‚¬ìš© ì‹œ **ë©”ì‹œì§€ ë°œí–‰ì˜ ì •í•©ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•œ í•µì‹¬ ì „ëµ** ì¤‘ í•˜ë‚˜ì´ë‹¤.  
ë‹¤ìŒì€ ë³¸ í”„ë¡œì íŠ¸ì— ì ìš©ëœ Outbox íŒ¨í„´ì˜ êµ¬í˜„ ë°©ì‹ì´ë‹¤. 

---

### Outbox í…Œì´ë¸” ë° ì—”í‹°í‹° í´ë˜ìŠ¤ 

ì•„ë˜ëŠ” Outbox í…Œì´ë¸”ì˜ DDLê³¼ JPA ì—”í‹°í‹° í´ë˜ìŠ¤ ì •ì˜ì´ë‹¤.

```sql
CREATE TABLE outbox (
    outbox_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    event_id VARCHAR(50) NOT NULL,                   -- ì´ë²¤íŠ¸ ID
    event_type VARCHAR(100) NOT NULL,                -- ì´ë²¤íŠ¸ íƒ€ì…
    partition_key BIGINT NOT NULL,                   -- íŒŒí‹°ì…˜ í‚¤
    payload TEXT NOT NULL,                           -- ì´ë²¤íŠ¸ í˜ì´ë¡œë“œ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP   -- ìƒì„± ì‹œê°„
);
```

```java
@Entity
public class Outbox {

    @Id
    @Column(name = "outbox_id")
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String eventId;

    @Enumerated(EnumType.STRING)
    @Column(length = 100)
    private EventType eventType;

    private Long partitionKey;

    @Lob
    @Column(columnDefinition = "TEXT")
    private String payload;

    private LocalDateTime createdAt;
}
```
---

### Outbox ë„ë©”ì¸ ì´ë²¤íŠ¸ ë°œí–‰ 

Outbox ì´ë²¤íŠ¸ëŠ” Springì˜ `ApplicationEvent` ê¸°ë°˜ìœ¼ë¡œ ë°œí–‰ëœë‹¤.
OutboxEvent í´ë˜ìŠ¤ëŠ” Auto(íŠ¸ëœì­ì…˜ ì¡´ì¬)ì™€ Manual(íŠ¸ëœì­ì…˜ ì—†ìŒ) ë‘ ê°€ì§€ ì¼€ì´ìŠ¤ë¥¼ ì œê³µí•œë‹¤.

+ Auto: ë„ë©”ì¸ ë¡œì§ ë‚´ `@Transactional`ì´ í¬í•¨ëœ ê²½ìš°
+ Manual: `@Transactional`ì´ ì—†ëŠ” ê²½ìš° ìˆ˜ë™ ë°œí–‰

Outbox ê°ì²´ë¥¼ ìƒì„±í•  ë•ŒëŠ” **ì§ë ¬í™” í¬ë§·ì˜ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ `Event` í´ë˜ìŠ¤ë¥¼ í™œìš©**í•œë‹¤.    
ì´ë²¤íŠ¸ IDëŠ” UUIDë¡œ ìƒì„±ë˜ë©°, í•´ë‹¹ IDì™€ ì´ë²¤íŠ¸ íƒ€ì…, í˜ì´ë¡œë“œë¥¼ `Event` ê°ì²´ì— ë‹´ì•„ **JSON ì§ë ¬í™”ëœ ë¬¸ìì—´ë¡œ ì €ì¥**í•œë‹¤.  
ì´ ë°©ì‹ì€ Kafka ë©”ì‹œì§€ ì†Œë¹„ ì¸¡ì—ì„œë„ **ì¼ê´€ëœ ì—­ì§ë ¬í™” êµ¬ì¡°ë¥¼ ìœ ì§€í•  ìˆ˜ ìˆê²Œ í•œë‹¤**.

```java
public class OutboxEventPublisherImpl implements OutboxEventPublisher {

    private final ApplicationEventPublisher eventPublisher;
    
    @Override
    public <T> void publishEvent(EventType type, Long partitionKey, T payload) {
        Outbox outbox = create(type, partitionKey, payload);
        OutboxEvent.Auto event = OutboxEvent.Auto.of(outbox);

        eventPublisher.publishEvent(event);
    }

    @Override
    public <T> void publishManualEvent(EventType type, Long partitionKey, T payload) {
        Outbox outbox = create(type, partitionKey, payload);
        OutboxEvent.Manual event = OutboxEvent.Manual.of(outbox);

        eventPublisher.publishEvent(event);
    }

    private <T> Outbox create(EventType type, Long partitionKey, T payload) {
        String eventId = UUID.randomUUID().toString();
        return Outbox.create(
            eventId,
            type,
            partitionKey,
            Event.of(eventId, type, payload).toJson()
        );
    }
}
```

Outboxì˜ payloadëŠ” ë‹¤ìŒê³¼ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ì§ë ¬í™”ëœë‹¤.

```json
{
    "eventId": "fee5d5ce-cdf7-4797-8baa-0cad19f80153",
    "eventType": "ORDER_CREATED",
    "payload": {
        // ì‹¤ì œ ì´ë²¤íŠ¸ í˜ì´ë¡œë“œ ë‚´ìš©
    }
}
```

---

### Outbox ë„ë©”ì¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ

ì´ë²¤íŠ¸ ë°œí–‰ í›„, Outboxë¥¼ ì²˜ë¦¬í•˜ëŠ” ë¦¬ìŠ¤ë„ˆ í´ë˜ìŠ¤ì´ë‹¤.

+ Auto ì´ë²¤íŠ¸ëŠ” íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì „ Outbox ì €ì¥ â†’ ì»¤ë°‹ í›„ Kafka ë°œí–‰
+ Manual ì´ë²¤íŠ¸ëŠ” ì¦‰ì‹œ Outbox ì €ì¥ í›„ Kafkaë¡œ ë°œí–‰

```java
public class OutboxEventListener {
    
    @TransactionalEventListener(phase = TransactionPhase.BEFORE_COMMIT)
    public void createOutbox(OutboxEvent.Auto event) {
        log.info("createOutbox - Auto ì•„ì›ƒ ë°•ìŠ¤ ì´ë²¤íŠ¸ ìˆ˜ì‹ : {}", event.getOutbox().getTopic());
        outboxService.createOutbox(event.getOutbox()); 
    }
    
    @Async
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void produceEvent(OutboxEvent.Auto event) {
        log.info("produceEvent - Auto ì•„ì›ƒ ë°•ìŠ¤ ì´ë²¤íŠ¸ ìˆ˜ì‹ : {}", event.getOutbox().getTopic());
        outboxService.produceEvent(event.getOutbox());
    }
    
    @Async
    @EventListener
    public void handle(OutboxEvent.Manual event) {
        log.info("produceEvent - Manual ì•„ì›ƒ ë°•ìŠ¤ ì´ë²¤íŠ¸ ìˆ˜ì‹ : {}", event.getOutbox().getTopic());
        outboxService.createOutbox(event.getOutbox());
        outboxService.produceEvent(event.getOutbox());
    }
}
```

---

### Outbox ì¹´í”„ì¹´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ

Kafkaë¡œ ì „ì†¡ëœ Outbox ì´ë²¤íŠ¸ëŠ” ì•„ë˜ ë¦¬ìŠ¤ë„ˆì—ì„œ ìˆ˜ì‹ ë˜ë©°,   
ìˆ˜ì‹ ëœ ì´ë²¤íŠ¸ì˜ eventIdë¥¼ ê¸°ë°˜ìœ¼ë¡œ Outbox í…Œì´ë¸”ì—ì„œ ë°ì´í„°ë¥¼ ì œê±°í•œë‹¤.

```java
public class OutboxMessageEventListener {

    private final OutboxService outboxService;

    @KafkaListener(topics = {
        Topic.COUPON_PUBLISH_REQUESTED,
        Topic.ORDER_COMPLETE_FAILED,
        Topic.ORDER_COMPLETED,
        Topic.ORDER_CREATED,
        Topic.PAYMENT_PAID,
        Topic.PAYMENT_FAILED,
        Topic.PAYMENT_CANCELED,
    }, groupId = GroupId.OUTBOX)
    public void handle(String message, Acknowledgment ack) {
        log.info("ì•„ì›ƒ ë°•ìŠ¤ ì´ë²¤íŠ¸ ìˆ˜ì‹  {}", message);

        Event<?> event = Event.of(message, Object.class);
        outboxService.clearOutbox(event.getEventId());
        ack.acknowledge();
    }
}
```

## ğŸ§¨ DLQ(Dead Letter Queue) êµ¬ì„±

Kafkaì—ì„œëŠ” ë©”ì‹œì§€ ì†Œë¹„ ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œ, ì¼ì • íšŸìˆ˜ ì¬ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨í•  ê²½ìš° í•´ë‹¹ ë©”ì‹œì§€ë¥¼ **DLQ(Dead Letter Queue)** ë¡œ ì „ì†¡í•˜ì—¬  
ì´í›„ ë³„ë„ë¡œ ë¶„ì„í•˜ê±°ë‚˜ ì¬ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤.

Spring Kafkaì—ì„œëŠ” **Bean ì„¤ì •ì„ í†µí•´ DLQë¥¼ ì†ì‰½ê²Œ êµ¬ì„±**í•  ìˆ˜ ìˆìœ¼ë©°, ì•„ë˜ëŠ” ê¸°ë³¸ì ì¸ ì„¤ì • ì˜ˆì‹œì´ë‹¤.

---

### DLQ ì„¤ì • ì˜ˆì‹œ

ë‹¤ìŒ ì„¤ì •ì€ **1ì´ˆ ê°„ê²©ìœ¼ë¡œ ìµœëŒ€ 3íšŒ ì¬ì‹œë„**í•œ í›„ì—ë„ ì‹¤íŒ¨í•œ ë©”ì‹œì§€ë¥¼ DLQë¡œ ì „ì†¡í•˜ëŠ” êµ¬ì„±ì´ë‹¤.

```java
@Configuration
public class KafkaConfig {

    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, String> kafkaListenerContainerFactory(
        ConsumerFactory<String, String> consumerFactory,
        KafkaTemplate<String, String> kafkaTemplate
    ) {
        ConcurrentKafkaListenerContainerFactory<String, String> factory = new ConcurrentKafkaListenerContainerFactory<>();
        factory.setConsumerFactory(consumerFactory);
        factory.getContainerProperties().setAckMode(ContainerProperties.AckMode.MANUAL);

        DeadLetterPublishingRecoverer recoverer = new DeadLetterPublishingRecoverer(kafkaTemplate);
        factory.setCommonErrorHandler(new DefaultErrorHandler(recoverer, new FixedBackOff(1000L, 3)));

        return factory;
    }
}
```

---

### DLQ í† í”½ ìƒì„± ë°©ì‹

Spring KafkaëŠ” ê¸°ë³¸ì ìœ¼ë¡œ DLQ í† í”½ ì´ë¦„ì— `-dlt` ì ‘ë¯¸ì‚¬ë¥¼ ë¶™ì—¬ ìë™ ìƒì„±í•œë‹¤.
ì˜ˆë¥¼ ë“¤ì–´, ì›ë˜ì˜ Topicì´ `order.created`ë¼ë©´, DLQ í† í”½ì€ `order.created-dlt`ë¡œ ìƒì„±ëœë‹¤.

Kafka UI ë˜ëŠ” CLIë¥¼ í†µí•´ ë‹¤ìŒê³¼ ê°™ì´ DLQ í† í”½ì´ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![img_5](https://github.com/user-attachments/assets/3384dbc0-9397-45a5-9902-0348cde5d973)

